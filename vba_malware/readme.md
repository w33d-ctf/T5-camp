# Analysis Report for Excel Marco VBA Malware
## analysys by 
YingMuo(彭建霖) and asef18766(陳兆閔)

## execution walkthough
1. this program will trigger ```userShorbaLoadr``` when user open the worksheet (in vba_src/ThisWorkbook.cls)

2. it will Create an zip file(revamap.zip with revamap.scr inside), unzip it and execute it(in vba_src/Module1.bas)

3. after execution of revamap.scr, it will drop an executable ```powerIso``` into ```C:\ProgramData``` and create link into startup

4. powerIso will connect to the c2 server ```kmcodecs.com``` and execute as persistant backdoor

## discovery walkthough
1. file it with linux ```file``` command first
```sh
$ file 4c6e1672d5bc9be4b12c794b33c1b082 
4c6e1672d5bc9be4b12c794b33c1b082: Composite Document File V2 Document, Little Endian, Os: Windows, Version 6.1, Code page: 1252, Author: JustinTronx, Last Saved By: JustinTronx, Name of Creating Application: Microsoft Excel, Create Time/Date: Mon Aug  5 06:00:23 2019, Last Saved Time/Date: Wed Aug 21 06:24:39 2019, Security: 0
```
2. since it was an ole object, we can use olevba to extract marcos
```sh
$ olevba.exe 4c6e1672d5bc9be4b12c794b33c1b082 > scripts.txt
```
3. according to marco, marco will use the content of UserForm1.TextBox1.Text(aka UserForm1.o) to split itself and write it into a zip file. Hence, we can use an python script to extract it(see revamap/export.py)

4. execute the revamap.scr(actually is a PE) with ```process mointor``` under the filter of ```operation is WriteFile```. We can observe that it will create the following objects
```
C:\ProgramData\PowerIso\PowerIso.scr -> BackDoor object
C:\Users\dio\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\PowerIso.lnk -> trigger PowerIso when startup
```

5. according to Detect It Easy, it was an .Net windows form application. Then we can use dnSpy to debug it.

6. inside the Form1 class, the string was encode as hexstring and separated with '-' character. ```C:\ProgramData\sgrmToner.exe``` is the decoded result in Form1's contructor

7. inside ```Translate``` function in ```Form1``` classes it will decrypt string with ```key``` and ```iv``` by PKCS7 padding CBC mode AES in ```Peptoprapy``` class
```
c:\windows\system32\cmd.exe /c start """"
\MsRuntime.vbs
SOFTWARE\Microsoft\Windows\CurrentVersion\Run
10
8.1
8
7
Vista
Software\Microsoft\Windows\CurrentVersion\Explorer\StartupApproved\Run
EnableLUA
SOFTWARE\Policies\Microsoft\Windows\Explorer
DisableNotificationCenter
.usercomp
.pcomp
senddevices
Name
OS
Intranet
typo
Ver
907291480
http://kmcodecs.com
A1L5C3endRa@l
b2sp-inutor
motos.php
Protege.php
dogfood.php
completenod.php
presidence.php
PayoneerSettle.php
eggseat.php
(Null string)
thickskin.php
Done
Error
pending
start
sendfile
SendFile=
data=
isd=
result=
comm=
compl=
swift
pascal
kotlin
lua
4092
6853
1900
```

8. after decrypt, it will try to connect to ```http://kmcodecs.com/A1L5C3endRa@l/b2sp-inutor/motos.php``` to obtain certificate as rsa certificate

9. after successfully connected to c2 server, it will gab system info and encrypt it then send to server (in ```PubsOses.ReadString```)

10. after sending system info, it will provide c2 server 2 functionality
    * semicolons: RCE via filedownloading (```TingTang.semicolons```)
    * bracket: tcp client with file downloading/uploading (```Retardser``` class)

other:
use ```API monitor``` check API be used in revamp. Important in it
* WriteFile to PowerIso.src from data segment 0x43adc8, it's the PE file
* WriteFile to PowerIso.src from a heap segment, its content is below, I don't know what it mean.
```
should 
    also set the 'EnableWindowsFormsHighDpiAutoResizing' setting to 'true' in their app.config. -->
    <!--
    <application xmlns="urn:schemas-microsoft-com:asm.v3">
        <windowsSettings>
        <dpiAware xmlns="http://schemas.microsoft.com/SMI/2005/WindowsSettings">true</dpiAware>
        </windowsSettings>
    </application>
    -->
    <!-- Enable themes for Windows common controls and dialogs (Windows XP and later) -->
    <!--
    <dependency>
        <dependentAssembly>
        <assemblyIdentity
            type="win32"
            name="Microsoft.Windows.Common-Controls"
            version="6.0.0.0"
            processorArchitecture="*"
            publicKeyToken="6595b64144ccf1df"
            language="*"
            />
        </dependentAssembly>
    </dependency>
    -->
    </assembly>                                                                                                                                                                                                                                                           
```
* ShellExecuteA to do below, I also don't know what it mean, maybe for bypass some check when create link later.
```
open C:\ProgramData\PowerIso\PowerIso.src
```
* then use some API to create link in startup

## group walkthrough
find the group may be ```https://weibo.com/ncsd?from=feed&loc=at&nick=Alexsd&is_all=1```

1. google ```sashasadovskyi7@gmail.com``` will find a url text with link between gmail and user ID, search ```sashasadovskyi7@gmail.com``` can get a ID ```AlexSD```

2. In RiskIQ search ```kmcodecs.com``` will find a IP ```206.81.26.164``` and a domain under it named ```mail.alexssd7.com```, so we can check the relation is reliable.

3. google ```AlexSD``` and then we can find his weibo.